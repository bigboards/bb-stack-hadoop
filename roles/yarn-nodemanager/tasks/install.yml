---
- name: check if the container exists
  shell: docker inspect hadoop-yarn-nodemanager 2>&1
  ignore_errors: yes
  register: container

- name: make sure the container exists
  shell: >
    docker run
    -d
    -p 8040:8040
    -p 8041:8041
    -p 8042:8042
    --name hadoop-yarn-nodemanager
    --net=host
    --expose 8040
    --expose 8041
    --expose 8042
    --volume /data/{{ tint.owner }}/{{ tint.id }}/config:${HADOOP_PREFIX}/etc/hadoop
    --volume /data/{{ tint.owner }}/{{ tint.id }}/data/yarn/nm:/data/hadoop/yarn/nm
    --add-host resourcemanager:{{ hostvars[hosts.resourcemanager]['ansible_eth0']['ipv4']['address']}}
    --add-host namenode:{{ hostvars[hosts.namenode]['ansible_eth0']['ipv4']['address']}}
    --add-host {{ ansible_local.hex.name }}-n1:{{hostvars[ansible_local.hex.name + '-n1']['ansible_eth0']['ipv4']['address']}}
    --add-host {{ ansible_local.hex.name }}-n2:{{hostvars[ansible_local.hex.name + '-n2']['ansible_eth0']['ipv4']['address']}}
    --add-host {{ ansible_local.hex.name }}-n3:{{hostvars[ansible_local.hex.name + '-n3']['ansible_eth0']['ipv4']['address']}}
    --add-host {{ ansible_local.hex.name }}-n4:{{hostvars[ansible_local.hex.name + '-n4']['ansible_eth0']['ipv4']['address']}}
    --add-host {{ ansible_local.hex.name }}-n5:{{hostvars[ansible_local.hex.name + '-n5']['ansible_eth0']['ipv4']['address']}}
    --add-host {{ ansible_local.hex.name }}-n6:{{hostvars[ansible_local.hex.name + '-n6']['ansible_eth0']['ipv4']['address']}}
    bigboards/hadoop-armv7l $HADOOP_PREFIX/bin/yarn --config $HADOOP_CONF_DIR nodemanager
  environment:
    USER: "root"
    HADOOP_PREFIX: "/opt/hadoop"
    HADOOP_COMMON_HOME: "/opt/hadoop"
    HADOOP_HDFS_HOME: "/opt/hadoop"
    HADOOP_MAPRED_HOME: "/opt/hadoop"
    HADOOP_YARN_HOME: "/opt/hadoop"
    HADOOP_CONF_DIR: "/opt/hadoop/etc/hadoop"
    YARN_CONF_DIR: "/opt/hadoop/etc/hadoop"
  when: container.stdout.find('"Id":') == -1

- name: make sure the init file is available
  template: src=etc/init/hadoop-yarn-nodemanager.conf dest=/etc/init/hadoop-yarn-nodemanager.conf

- name: make sure the service is started at boot
  service: name=hadoop-yarn-nodemanager enabled=yes state=started