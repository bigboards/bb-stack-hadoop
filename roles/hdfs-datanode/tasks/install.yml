- name: check if the container exists
  shell: docker inspect hadoop-hdfs-datanode 2>&1
  ignore_errors: yes
  register: container

- name: make sure the container exists
  shell: >
    docker run
    -d
    -p 1004:1004
    -p 1006:1006
    -p 50010:50010
    -p 50075:50075
    -p 50020:50020
    --name hadoop-hdfs-datanode
    --net=host
    --expose 1004
    --expose 1006
    --expose 50010
    --expose 50075
    --expose 50020
    --volume /data/{{ tint.owner }}/{{ tint.id }}/config:${HADOOP_PREFIX}/etc/hadoop
    --volume /data/{{ tint.owner }}/{{ tint.id }}/data/hdfs/dn:/data/hadoop/dfs/dn
    --add-host resourcemanager:{{ hostvars[hosts.resourcemanager]['ansible_eth0']['ipv4']['address']}}
    --add-host namenode:{{ hostvars[hosts.namenode]['ansible_eth0']['ipv4']['address']}}
    --add-host {{ ansible_local.hex.name }}-n1:{{hostvars[ansible_local.hex.name + '-n1']['ansible_eth0']['ipv4']['address']}}
    --add-host {{ ansible_local.hex.name }}-n2:{{hostvars[ansible_local.hex.name + '-n2']['ansible_eth0']['ipv4']['address']}}
    --add-host {{ ansible_local.hex.name }}-n3:{{hostvars[ansible_local.hex.name + '-n3']['ansible_eth0']['ipv4']['address']}}
    --add-host {{ ansible_local.hex.name }}-n4:{{hostvars[ansible_local.hex.name + '-n4']['ansible_eth0']['ipv4']['address']}}
    --add-host {{ ansible_local.hex.name }}-n5:{{hostvars[ansible_local.hex.name + '-n5']['ansible_eth0']['ipv4']['address']}}
    --add-host {{ ansible_local.hex.name }}-n6:{{hostvars[ansible_local.hex.name + '-n6']['ansible_eth0']['ipv4']['address']}}
    bigboards/hadoop-armv7l $HADOOP_PREFIX/bin/hdfs --config $HADOOP_CONF_DIR datanode
  environment:
    USER: "root"
    HADOOP_PREFIX: "/opt/hadoop"
    HADOOP_COMMON_HOME: "/opt/hadoop"
    HADOOP_HDFS_HOME: "/opt/hadoop"
    HADOOP_MAPRED_HOME: "/opt/hadoop"
    HADOOP_YARN_HOME: "/opt/hadoop"
    HADOOP_CONF_DIR: "/opt/hadoop/etc/hadoop"
    YARN_CONF_DIR: "/opt/hadoop/etc/hadoop"
  when: container.stdout.find('"Id":') == -1

- name: make sure the init file is available
  template: src=etc/init/hadoop-hdfs-datanode.conf dest=/etc/init/hadoop-hdfs-datanode.conf

- name: make sure the service is started at boot
  service: name=hadoop-hdfs-datanode enabled=yes state=started